Option Explicit
'================ Link Register builder (robust) ===============
Sub BuildLinkRegister()
    Const WS_NAME As String = "Link_Register"
    
    Dim wsOut As Worksheet, nxtRow As Long
    Dim sh As Worksheet, rngF As Range, c As Range
    Dim links As Variant, linkItem As Variant
    
    '----- 出力シート準備 -----
    Application.DisplayAlerts = False
    On Error Resume Next: Worksheets(WS_NAME).Delete: On Error GoTo 0
    Application.DisplayAlerts = True
    
    Set wsOut = Worksheets.Add(Before:=Sheets(1))
    wsOut.Name = WS_NAME
    wsOut.Range("A1:G1").Value = Array("#", "Sheet", "Cell", _
                                       "Type", "Target", "Note", "Depth")
    nxtRow = 2
    
    '----- 外部リンクソース -----
    links = ActiveWorkbook.LinkSources(xlExcelLinks)
    
    If Not (IsEmpty(links) Or links Is Nothing) Then
        If IsArray(links) Then
            For Each linkItem In links
                WriteRow wsOut, nxtRow, "", "", "External Source", CStr(linkItem)
            Next linkItem
        Else
            'リンクが１件のみの場合に配列で返らないレアケース対策
            WriteRow wsOut, nxtRow, "", "", "External Source", CStr(links)
        End If
    End If
    
    '----- シートごとの数式走査 -----
    For Each sh In Worksheets
        If sh.Name <> WS_NAME Then
            On Error Resume Next
            Set rngF = sh.UsedRange.SpecialCells(xlCellTypeFormulas)
            On Error GoTo 0
            
            If Not rngF Is Nothing Then
                For Each c In rngF
                    Dim typ As String, tgt As String
                    If InStr(c.Formula, "[") > 0 Then
                        typ = "External"
                    ElseIf InStr(c.Formula, "!") > 0 Then
                        typ = "Internal"
                    Else
                        typ = ""
                    End If
                    
                    If typ <> "" Then
                        tgt = FirstRef(c.Formula)
                        WriteRow wsOut, nxtRow, sh.Name, _
                                 c.Address(False, False), typ, tgt
                    End If
                Next c
            End If
            Set rngF = Nothing
        End If
    Next sh
    
    wsOut.Columns.AutoFit
    MsgBox "Link register refreshed: " & nxtRow - 2 & " rows", vbInformation
End Sub

'---------- 参照セル抽出 ----------
Private Function FirstRef(f As String) As String
    With CreateObject("VBScript.RegExp")
        .Pattern = "('([^']+)'|[A-Za-z0-9_]+)?!?[$]?[A-Z]{1,3}[$]?\d+"
        .Global = False
        If .Test(f) Then FirstRef = .Execute(f)(0).Value
    End With
End Function

'---------- 出力ヘルパ ----------
Private Sub WriteRow(ws As Worksheet, ByRef r As Long, _
                     sht As String, addr As String, typ As String, _
                     tgt As String, Optional note As String = "", _
                     Optional dep As Variant)
    With ws
        .Cells(r, 1).Value = r - 1
        .Cells(r, 2).Value = sht
        .Cells(r, 3).Value = addr
        .Cells(r, 4).Value = typ
        .Cells(r, 5).Value = tgt
        .Cells(r, 6).Value = note
        If Not IsMissing(dep) Then .Cells(r, 7).Value = dep
    End With
    r = r + 1
End Sub