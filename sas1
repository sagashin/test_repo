Proc SQLにあるsasds.data_1にDWH_CURRENT_PROD_MSTからBranchを追加したい。以下のメモのようにDWH_AUTO_FACT経由でPFM_AUTO_FACTにつなげられるみたいです。追加のコードを提案して。

DWH_CURRENT_PROD_MST
は、
OLD_PRODUCER_CD
がジョインキーです。
しかし今のプログラムの中には、
OLD_PRODUCER_CD
を持つテーブルはありません。
なので、
OLD_PRODUCER_CD
をDWH辞書で検索すると、
DWH_AUTO_FACT
とジョインできそうなことがわかります。
DWH_AUTO_FACT
と
PFM_AUTO_FACT
は左記のジョインキーでマージできます。
KEY_POLICY_NO
KEY_POLICY_ITEMNO
KEY_ORIG_INS_EFFECT_YY
KEY_COMPANY_CD
KEY_EXTRACT_MASTER_FLG


PROC SQL ;
	CONNECT TO oracle AS aiuprod (user=&orcluser2 orapw=&orclpw2 path="&orclpath2"/*USER= "" ORAPW= "" PATH= "AIDWHP1_CMAN"*/) ;

	CREATE TABLE sasds.data_1 AS
	SELECT *
	FROM CONNECTION TO aiuprod (
		SELECT
		    /*分析に必要な集計キーはここから*/
		    fact.KEY_POLICY_NO,
			fact.KEY_POLICY_ITEMNO,
			fact.KEY_ORIG_INS_EFFECT_YY,
			fact.KEY_COMPANY_CD,
			fact.KEY_EXTRACT_MASTER_FLG,
            fact.ORIG_INS_COMPANY_CD,
			fact.NEW_RENEWAL_TYP, /*added 20250730*/
			ep_summ.EARNED_YYM,
			product.AUTO_PRODUCT_CD,
			product.FLEET_FLG,
			product.PRODUCT_NAME,
			military.MILITARY_CARCLASS_CD,
			military.MILITARY_GRADE_CD,
			military.MILITARY_OD_A_INSURED_AMT,
			military.MILITARY_OD_A_PRM,
			military.MILITARY_OD_B_INSURED_AMT,
			military.MILITARY_OD_B_PRM,
			military.MILITARY_DISCOUNT_RATE,
			military.MILITARY_SHORTTERM_RATE,
			military.MILITARY_AO_CD,
			plhldr.CRESTA_ZONE,
			plhldr.CRESTA_CD,
			plhldr.AREA_NAME,
			plhldr.ADDRESS_CD,
			addrss.ADDRESS_NAME_KN,
			addrss.ADDRESS_NAME_KJ,
			addrss.NEW_ZIP,
			/*分析に必要な集計キーはここまで*/
			sum(ep_summ.TOTAL_EARNED_PRM) AS total_ep,
			sum(ep_summ.OD_EARNED_PRM) AS od_ep,
			sum(ep_summ.BI_EARNED_PRM) AS bi_ep,
			sum(ep_summ.PD_EARNED_PRM) AS pd_ep,
			sum(ep_summ.PA_EARNED_PRM) AS pa_ep,
			sum(ep_summ.PIC_EARNED_PRM) AS pic_ep,
			sum(ep_summ.ESCORTP_EARNED_PRM) AS escortp_ep,
			sum(ep_summ.BIKE50CC_EARNED_PRM) AS bike50cc_ep,
			sum(ep_summ.OTHERS_EARNED_PRM) AS others_ep,
			sum(ep_summ.TOTAL_NOVE) AS total_nove
		FROM
			PFM_AUTO_FACT fact,
			PFM_AUTO_MILITARY military,
			PFM_AUTO_EP_SUMM ep_summ,
			PFM_AUTO_PRODUCT product,
			(PFM_AUTO_POLICYHOLDER plhldr LEFT JOIN DWH_ADDRESS_MST addrss ON (plhldr.ADDRESS_CD = addrss.ADDRESS_CD))

		WHERE
		    /*ep_summ.EARNED_YYM >= '202401' AND/*★★★変更部分★★★*/
			ep_summ.EARNED_YYM <= '202507' AND/*★★★変更部分★★★*/
			/*fact.orig_policy_effective_date < TO_DATE('2024-01-01', 'YYYY-MM-DD') AND
			fact.orig_policy_expire_date >= TO_DATE('2023-01-01', 'YYYY-MM-DD') AND*/

			/*factテーブルのデータ（基本的には証券番号・枝番で一意となっているデータ）に対して、各証券番号・枝番のアーンド年月の情報を追加*/
			fact.KEY_POLICY_NO = ep_summ.KEY_POLICY_NO AND
			fact.KEY_POLICY_ITEMNO = ep_summ.KEY_POLICY_ITEMNO AND
			fact.KEY_ORIG_INS_EFFECT_YY = ep_summ.KEY_ORIG_INS_EFFECT_YY AND
			fact.KEY_COMPANY_CD = ep_summ.KEY_COMPANY_CD AND
			fact.KEY_EXTRACT_MASTER_FLG = ep_summ.KEY_EXTRACT_MASTER_FLG AND

			fact.PFM_AUTO_PRODUCT_KEY = product.PFM_AUTO_PRODUCT_KEY AND

			/*factテーブルのデータ（基本的には証券番号・枝番で一意となっているデータ）に対して、ミリタリーの情報を追加*/
			fact.PFM_AUTO_MILITARY_KEY = military.PFM_AUTO_MILITARY_KEY AND
			fact.PFM_AUTO_POLICYHOLDER_KEY = plhldr.PFM_AUTO_POLICYHOLDER_KEY


        GROUP BY
		    /*分析に必要な集計キーはここから*/
			fact.KEY_POLICY_NO,
			fact.KEY_POLICY_ITEMNO,
			fact.KEY_ORIG_INS_EFFECT_YY,
			fact.KEY_COMPANY_CD,
			fact.KEY_EXTRACT_MASTER_FLG,
			fact.ORIG_INS_COMPANY_CD,
			fact.NEW_RENEWAL_TYP, /*added 20250730*/
			ep_summ.EARNED_YYM,
		    product.AUTO_PRODUCT_CD,
			product.FLEET_FLG,
			product.PRODUCT_NAME,
			military.MILITARY_CARCLASS_CD,
			military.MILITARY_GRADE_CD,
			military.MILITARY_OD_A_INSURED_AMT,
			military.MILITARY_OD_A_PRM,
			military.MILITARY_OD_B_INSURED_AMT,
			military.MILITARY_OD_B_PRM,
			military.MILITARY_DISCOUNT_RATE,
			military.MILITARY_SHORTTERM_RATE,
			military.MILITARY_AO_CD,
			plhldr.CRESTA_ZONE,
			plhldr.CRESTA_CD,
			plhldr.AREA_NAME,
			plhldr.ADDRESS_CD,
			addrss.ADDRESS_NAME_KN,
			addrss.ADDRESS_NAME_KJ,
			addrss.NEW_ZIP
			/*分析に必要な集計キーはここまで*/
	) ;

	DISCONNECT FROM aiuprod ;
QUIT ;
